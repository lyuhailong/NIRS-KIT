# 注：数据分析记录：

0，核心参数：**视觉确定文件总体时间、任务开始时间、结束时间、设备采样频率。**

1，数据加载，对于余杭新机器的数据，需要用HORM转换成.nirs文件采用Type11 HOMR2 OD raw .nirs方式导入，Spatial可选；对于日立近红外数据，可以直接type 1或type 4导入（HB）数据是日立机器自己转换好的数据；

2，数据预处理可视化用来检查是否有报错；

3，数据预处理，有两种设定，但是注意滤波频率的设定，对于125秒的数据任务频率为1/125=0.008; 有时间段截取功能；有自我定义的信号分析功能函数（不报错可以用）；还有重采样功能，参考.md文件。

# 0 关于带通滤波
滤波（Filtering）：NIRS-KIT 提供三种滤波器（高通、低通和带通滤波），以去除不相关的低频和/或高频成分[如图 4.3(D)所示]。提供了三种常用的数字滤波器类型：
无限脉冲响应（IIR）滤波器、有限脉冲响应（FIR）滤波器和基于快速傅里叶变换
的滤波器（基于 FFT 的滤波器）。NIRS-KIT 中使用的 IIR 过滤器是 Butterworth
滤波器（默认三阶）。FIR 滤波器是一个 Hamming 窗滤波器（默认第 34 阶）。
对于基于 FFT 的滤波器，将每个通道的时间序列变换到频域，对频域信号进行滤波，然后再变换回时域。默认情况下，使用三阶 IIR 滤波器进行带通滤波（0.01 至
0.08 Hz）。使用者可根据研究目标和噪声特性指定滤波模型、高频和/或低频阈值以
及滤波器类型。

**注意，对于任务态分析，不应过滤掉特定于任务的频率:**

在 fNIRS（功能性近红外光谱）数据分析中，**滤波（Filtering）** 是关键的预处理步骤，用于去除不需要的噪声和信号漂移。滤波器的设置直接影响后续分析的准确性，尤其是在任务态分析中，需要确保滤波器不会滤除与任务相关的信号频率。

### **您的具体问题**
您提到的实验设计如下：
- **总时长**：2分30秒（150秒）
- **阶段**：
  1. **静息态**：30秒
  2. **VET（言语流畅性任务）**：60秒
  3. **数数任务**：“1，2，3”连续数数60秒

您提出的滤波设置为**低通滤波（Low-pass Filtering）**，上限设为**0.01 Hz**，即仅保留低于0.01 Hz的频率成分。

### **1. 低通滤波 0.01 Hz 的含义**

**低通滤波器（Low-pass Filter）**允许低于特定截止频率的信号通过，而衰减高于该频率的信号。将上限设置为0.01 Hz，意味着：
- **保留**：频率低于0.01 Hz的信号
- **衰减**：频率高于0.01 Hz的信号

### **2. 任务频率与滤波器设置的关系**

根据您的实验设计：
- **任务频率计算**：
  \[
  f_{\text{任务}} = \frac{1}{\text{总周期时间}} = \frac{1}{150 \text{秒}} \approx 0.0067 \, \text{Hz}
  \]
  **这表示任务相关的信号主要集中在约0.0067 Hz。**


### **3. 低通滤波 0.01 Hz 的适用性**

**优点**：
- **保留任务相关信号**：由于任务频率（0.0067 Hz）低于0.01 Hz，上限设为0.01 Hz的低通滤波器将保留您的任务相关信号。
- **去除高频噪声**：有效去除心跳、呼吸等高频噪声，提高信噪比。

**潜在问题**：
- **低频漂移**：fNIRS信号中还存在比0.0067 Hz更低频的漂移（例如仪器漂移），这些可能不会被滤除，导致基线不稳定。
- **边界效应**：滤波器在信号的起始和结束部分可能引入延迟或失真，尤其是在较短的时间序列中（如150秒）。

### **4. 替代滤波策略**
如果实验设计中的任务期较长且任务频率较低，可以选择更适合的滤波器设置：

	•	较宽的频率范围：如 0.005-0.1 Hz，以覆盖任务相关的低频信号。


#### **b. 高通滤波（High-pass Filtering）**
与低通滤波相反，高通滤波器去除低于特定频率的信号，保留高于该频率的信号。

**不推荐**：
- 对于您的任务频率，使用高通滤波器可能会滤除任务相关的低频信号，因此不适用。

#### **c. 低通滤波与高通滤波结合**
结合低通和高通滤波器的优点，形成带通滤波器。

**建议**：
- **下限**：0.005 Hz
- **上限**：0.08 Hz

这样可以有效保留任务相关信号，同时去除高频噪声和部分低频漂移。

### **5. 使用广义线性模型（GLM）辅助滤波**

**GLM** 本身可以建模任务相关信号和基线信号，通过设计矩阵区分不同条件。因此，结合GLM的使用，可以在滤波时放宽一些限制，依靠GLM来区分信号成分。

**建议**：
- **滤波器设置**：适度调整滤波器参数（如下限至0.005 Hz），以保留更多信号信息。
- **GLM建模**：利用设计矩阵中的任务模型，进一步提取任务相关信号，减少对严格滤波的依赖。

### **6. 实验数据的频谱分析**

在最终确定滤波器参数之前，进行频谱分析有助于了解信号的频率分布，确保滤波器设置合理。

**步骤**：
1. **快速傅里叶变换（FFT）**：
   ```matlab
   Y = fft(raw_data);
   L = length(raw_data);
   P2 = abs(Y/L);
   P1 = P2(1:floor(L/2)+1);
   P1(2:end-1) = 2*P1(2:end-1);
   f = Fs*(0:(floor(L/2)))/L;
   plot(f, P1);
   xlabel('Frequency (Hz)');
   ylabel('|P1(f)|');
   title('Frequency Spectrum');
   ```
2. **分析频谱**：观察任务频率（约0.0067 Hz）及其附近的频率成分，确认是否需要调整滤波器参数。

### **7. 具体推荐**

结合上述分析，以下是针对您的实验设计的具体建议：

1. **采用带通滤波器**，下限设置为**0.005 Hz**，上限为**0.08 Hz**，以确保保留任务相关信号（0.0067 Hz）。
   - **MATLAB 示例**：
     ```matlab
     low_cutoff = 0.005;
     high_cutoff = 0.08;
     [b, a] = butter(2, [low_cutoff high_cutoff] / (Fs/2), 'bandpass');
     filtered_data = filtfilt(b, a, raw_data);
     ```
   - **优点**：保留任务相关信号，去除高频噪声和部分低频漂移。

2. **如果坚持使用低通滤波**，设置上限为**0.01 Hz**也是可行的，但需要注意：
   - **保留任务信号**：0.0067 Hz < 0.01 Hz，任务信号将被保留。
   - **潜在低频漂移**：可能需要进一步处理低频漂移，如使用高通滤波或其他去漂移方法。
   - **滤波器设计**：确保滤波器阶数适当，避免引入显著的相位延迟或信号失真。

3. **结合GLM建模**：
   - **设计矩阵**：在GLM中准确建模不同任务条件（静息、VET、数数），有效区分信号成分。
   - **滤波参数**：可以适当放宽滤波器参数，依靠GLM来提取任务相关信号。

### **总结**

**使用低通滤波器并设置上限为0.01 Hz是可行的**，特别是在您的任务频率为0.0067 Hz的情况下。然而，为了更好地保留任务相关信号并去除不需要的低频漂移，**建议采用带通滤波器**，下限设置为0.005 Hz，上限为0.08 Hz。这种设置能够有效保留任务相关的低频信号，同时减少高频噪声和低频漂移的影响。

此外，结合**广义线性模型（GLM）**的使用，可以进一步优化信号提取和任务相关分析，提高数据分析的准确性和可靠性。

如果您坚持使用低通滤波器，确保：
- **滤波器设计合理**，避免引入信号失真。
- **后续处理步骤**（如GLM建模）能够有效区分和提取任务相关信号。

### **参考文献**
- Huppert, T. J., Diamond, S. G., Franceschini, M. A., & Boas, D. A. (2009). HomER: a review of time-series analysis methods for near-infrared spectroscopy of the brain. **Applied Optics**, 48(10), D280-D298.
- Ferrari, M., & Quaresima, V. (2012). A brief review on the history of human functional near-infrared spectroscopy (fNIRS) development and fields of application. **Neuroscience**, 204, 10-25.


# 1. 创建 Contrasts的意义

对比向量（contrast vector）可用于估计信号在单个条件、多个条件的平均值或两个条件之间的幅值差（图 4.4.4）。设置对比向量的步骤：

- 1) 添加数据路径：该文件夹包含上一步模型估计后生成的所有被试的 GLM 文件；

- 2) 设置输出文件夹；

- 3) 添加对比 contrast；

	a. Name: 数据 contrast 名称

	b. Contrast Vector: 输入对比向量 contrast vector，例如“1 -1”或者“0 1 0”。
	
在 fNIRS 数据分析中，**对比向量 (contrast vector)** 用于定义不同条件下的脑部激活情况或任务效果之间的差异。`1 -1` 或者 `0 1 0` 这样的向量定义了对实验中不同条件的比较或某些条件的平均效应。

具体来说，这些对比向量的含义如下：

###  **1. `1 -1` 对比向量**
这个对比向量用于比较两个条件的差异，通常用于两种实验条件之间的直接对比。假设你有两个实验条件，例如：
- 条件 A：组词并说出来
- 条件 B：说“1，2，3”

`1 -1` 表示要对比条件 A 和条件 B：
- `1` 代表条件 A 的权重
- `-1` 代表条件 B 的权重

这样，`1 -1` 就是在计算**条件 A 和条件 B 的差异**，即你想要知道在条件 A 时的激活情况是否显著不同于条件 B。

### **2. `0 1 0` 对比向量**
这个对比向量用于在多个条件中选择特定的条件。假设你有三个实验条件：
- 条件 A
- 条件 B
- 条件 C

`0 1 0` 的意思是你只关心条件 B 的激活情况：
- `0` 代表忽略条件 A
- `1` 代表对条件 B 进行分析
- `0` 代表忽略条件 C

这样，`0 1 0` 就会计算**条件 B 的激活情况**，而不涉及条件 A 或 C。

### **对比向量的设置原则**
1. **每个数字对应设计矩阵中的一个条件**：
   对比向量中的每一个数字对应设计矩阵中的一列（每列代表一个实验条件）。正值表示该条件对激活有正贡献，负值表示该条件对激活有负贡献，0 表示忽略该条件。

2. **权重分配**：
   - `1`：表示将该条件的激活信号包含在对比中。
   - `-1`：表示将该条件的激活信号反向考虑（例如用于计算条件差异）。
   - `0`：表示忽略该条件，不纳入分析。

3. **自动补零**：
   当你没有为所有条件设置权重时，系统会自动在对比向量的右边补零。例如，对于三个条件，如果你只关心前两个条件（如 `1 -1`），系统会自动补上一个零，成为 `1 -1 0`，代表忽略第三个条件。


### 总结：
- `1 -1`：比较两个条件的激活差异，例如任务 A 和任务 B。
- `0 1 0`：只关注特定条件的激活，例如只分析条件 B 的激活情况。

选择和设置对比向量时，应基于你所关心的实验条件或任务对比。

## 对于VFT实验的设定解释

先是30秒的静息态，然后是60秒的VFT实验，然后是60秒的“1，2，3”数数，这种情况对比向量 (contrast vector) 该怎么设置？

对于这种实验设计，涉及三个阶段：**静息态** (30 秒)、**VET 实验** (60 秒) 和 **数数任务** (60 秒)，可以使用对比向量 (contrast vector) 来分析这些条件的差异。

假设你在设计矩阵中有三个条件，分别为：
1. 静息态 (Rest)
2. VET 任务 (VET)
3. 数数任务 (Counting)

### 对比向量设置方法：

1. **对比 VET 任务与静息态**：
   - 如果你想对比 VET 任务和静息态，设置对比向量为 `0 1 0`。这是因为：
     - 静息态的权重为 `0`（忽略）
     - VET 任务的权重为 `1`（关注这个条件）
     - 数数任务的权重为 `0`（忽略）

   这样，`0 1 0` 的对比向量会专注于 VET 任务和静息态之间的差异。

2. **对比数数任务与静息态**：
   - 如果你想对比数数任务和静息态，设置对比向量为 `0 0 1`。这是因为：
     - 静息态的权重为 `0`（忽略）
     - VET 任务的权重为 `0`（忽略）
     - 数数任务的权重为 `1`（关注这个条件）

   这样，你可以计算数数任务和静息态之间的差异。

3. **对比 VET 任务与数数任务**：
   - 如果你想对比 VET 任务和数数任务，设置对比向量为 `0 1 -1`。这是因为：
     - 静息态的权重为 `0`（忽略）
     - VET 任务的权重为 `1`（正向关注 VET 任务）
     - 数数任务的权重为 `-1`（负向表示数数任务）

   这样，`0 1 -1` 会对比 VET 任务与数数任务之间的激活差异。

### 总结
- **VET vs 静息态**: `0 1 0`
- **数数 vs 静息态**: `0 0 1`
- **VET vs 数数**: `0 1 -1`

这些对比向量能够帮助你在不同任务和静息态之间进行脑部激活情况的分析。

设置：可以同时设置上面的两个对比：VFTvsREST and VFTvsCOUNT， NIRS_KIT会同时计算两种情况，激活结果保存成不同的文件夹con1 and con2。
![](/Users/hailong/Desktop/截屏2024-09-16 16.34.37.png)


# 2. 分析结果解释

fNIRS数据针对单一任务态的激活分析，采用GLM法分析之后得到了beta_0和beta_1，应该选择哪个数值做进一步分析？ 哪一个是代表任务态激活的？

在 fNIRS 数据中针对单一任务态的激活分析，采用广义线性模型 (GLM) 分析之后，得到的参数 **beta_0** 和 **beta_1** 代表了模型中不同的部分：

1. **beta_0**：这个参数通常是 **截距项**，也称为基线（baseline），它代表在没有任务时（即休息态）fNIRS 信号的平均水平。它反映的是与任务无关的全局信号或背景活动。

2. **beta_1**：这个参数是与 **任务态**（task-related activity）相关的 **回归系数**。它表示在任务执行期间，与任务相关的激活对 fNIRS 信号变化的贡献。通常，beta_1 越大，说明任务态对信号的影响越强，代表了与任务态相关的血氧动力学变化。

### 应选择哪个参数进行进一步分析？

对于单一任务态的激活分析，你通常应该选择 **beta_1** 进行进一步分析，因为它反映了 **与任务相关的激活程度**。也就是说，beta_1 是任务执行期间脑区激活的指标。更具体地说：

- 如果 **beta_1 > 0**，说明任务态期间的 fNIRS 信号增加，这意味着可能有与任务相关的脑部激活。
- 如果 **beta_1 < 0**，说明任务态期间的信号减少，这可能代表抑制或任务期间的负向激活。

### 总结

在基于 GLM 分析 fNIRS 数据时，**beta_1** 是代表任务态激活的回归系数，因此应选择 **beta_1** 进行进一步分析。例如，你可以使用 beta_1 来进行组间比较、条件间比较或与行为表现相关联的分析。



# 3. NRIS_KIT数据处理代码修改说明

针对67导联数据，头动校正TDDR时间导数分布修复（Temporal Derivative Distribution Repair）因报错无法进行，采用CBSI (Cui et al., 2010): 基于相关性的信号质量提升法；但是在进行头动校正后出现很多确实值，所以在进入滤波之前添加了代码（感谢Curser）进行缺失值插补处理，添加代码的文件为`NR_filter.m` 添加代码如下：

```matlab
function nirsdata=NR_filter(nirsdata,FilterMethod,FilterModel,FilterOrder,hpf,lpf)

% Filter on the input images
%
%
% Input:
% filter_mathod:  1 = IIR; 2 = FIR; 3 = FFT.
% filter_type: 1 = high pass; 2 = low pass; 3 = bandpass.
% 
% 检查并处理非有限值
fields = {'oxyData', 'dxyData', 'totalData'};
for i = 1:length(fields)
    field = fields{i};
    data = nirsdata.(field);
    
    % 详细检查数据
    non_finite = ~isfinite(data);
    nan_values = isnan(data);
    inf_values = isinf(data);
    
    if any(non_finite(:)) || any(nan_values(:)) || any(inf_values(:))
        warning('在 %s 中发现问题值：\n非有限值: %d\nNaN值: %d\n无穷大值: %d', ...
            field, sum(non_finite(:)), sum(nan_values(:)), sum(inf_values(:)));
        
        % 尝试多种方法处理问题值
        % 1. 线性插值
        data = fillmissing(data, 'linear', 'EndValues', 'nearest');
        
        % 2. 如果还有问题，使用移动中位数填充
        if any(isnan(data(:)) | isinf(data(:)))
            data = fillmissing(data, 'movmedian', 5, 'EndValues', 'nearest');
        end
        
        % 3. 如果仍然存在问题，用列的中位数替换
        problem_indices = isnan(data) | isinf(data);
        for col = 1:size(data, 2)
            col_median = median(data(:,col), 'omitnan');
            data(problem_indices(:,col), col) = col_median;
        end
        
        % 最后检查
        if any(isnan(data(:)) | isinf(data(:)))
            warning('在 %s 中仍存在问题值，将使用全局中位数替换。', field);
            global_median = median(data(:), 'omitnan');
            data(isnan(data) | isinf(data)) = global_median;
        end
        
        nirsdata.(field) = data;
        disp(['已处理 ' field ' 中的问题值。']);
    end
end

% 最终检查
for i = 1:length(fields)
    field = fields{i};
    data = nirsdata.(field);
    if any(isnan(data(:)) | isinf(data(:)))
        error('无法完全处理 %s 中的问题值，请检查原始数据。', field);
    end
end

 % 原有的滤波代码
```

滤波设定：`FIR band pass 0.01-0.08HZ`

日立机器：Sampling Period 0.1s；任务时间60秒，任务前的时间10秒，即任务是第10-70秒之间，所以对应的scan应该是100-700。

| Pre Time[s] | 10 |
| --- | --- |
| Post Time[s] | 5 |
| Recovery Time[s] | 50 |
| Base Time[s] | 5 |

这个新机器：Sampling Period0.02s；原始数据文件没有做标记，检查后发现任务前时间30秒，即任务是第30-90秒之间，所以对应的Scan应该是1500-4500。这个任务的总时间在CH53的机器是3分30秒，在CH67的机器是2分30秒。

| Pre Time[s] | 30 |
| --- | --- |
| Post Time[s] | 60 |
| Recovery Time[s] | 60 |
| Base Time[s] | 10 |

# 4. 针对头动校正的解释：

在处理功能近红外光谱 (fNIRS) 数据的过程中，头动校正是一项重要的步骤，常用的校正方法包括 **CBSI (Correlation-Based Signal Improvement)** 和 **TDDR (Temporal Derivative Distribution Repair)**。然而，在应用这些校正方法后，可能会出现缺失值 (NA) 的情况。这通常与以下几个原因相关：

1. **校正过程中数据丢失**：由于头动校正算法会对数据进行滤波、差分等操作，一些数据点可能会被认为是异常点或噪声而被排除，从而导致缺失值。
2. **边界效应**：某些算法会在信号的起始或结束处引入缺失值（例如差分操作），这是因为在计算导数或移动平均时缺乏足够的数据点。

### 解决方案及避免缺失值的策略

1. **预处理步骤前的数据筛选和清理**：
    - **去除极端异常值**：在应用校正方法之前，可以先检测和剔除一些可能的异常值（如头动幅度特别大的时段），以减少校正过程中不必要的干扰。
    - **平滑处理**：可以在校正前先对数据进行一定程度的平滑处理，减少尖锐的信号波动，这样校正算法处理时不至于过度“修正”数据。
2. **CBSI 校正**：
    - **原理**：CBSI 校正依赖于全局信号变化的相关性，因此在一些情况下，头动产生的噪声可能与真实信号混合，导致校正后的值不合理。
    - **避免缺失值的策略**：CBSI 处理时避免过度依赖局部信号的变化，将参数设定为更宽松的范围来避免校正过程中产生 NA 值。同时，CBSI 的校正步骤本身并不会直接引入 NA 值，NA 主要出现在原始数据已经存在异常的情况下，因此确保原始数据的清洁是关键。
3. **TDDR 校正**：
    - **原理**：TDDR 校正通过计算时间导数来修正头动的影响。然而，这种方法有时会在信号的边界处或导数计算后引入 NA，特别是在短时间数据段中。
    - **避免缺失值的策略**：
        - **填充边界数据**：为避免边界处出现 NA，可以在数据的两端进行适当的填充或外推，从而避免导数计算中缺失数据点。
        - **调整窗口参数**：如果 TDDR 使用了滑动窗口方法来处理导数，确保窗口大小合适，避免窗口过小导致过度平滑或误差放大。
4. **后处理步骤：NA 值处理**：
    - **插值法处理 NA**：在校正后出现 NA 值的情况下，可以采用插值方法（例如线性插值、样条插值等）填补这些缺失点，保持数据的连续性。
    - **局部平均法**：在少量缺失值情况下，可以用邻近数据的局部平均值来替代 NA 值。
    - **剔除小片段数据**：如果某段数据存在大量 NA，可以考虑将这部分数据剔除，尤其是在该段数据不具备可分析性的情况下。
        
        ```matlab
        % 代码见上
        ```
        
5. **回顾数据集整体质量**：
    - 在进行校正之前，务必对整体数据集的质量进行评估，确保不会由于过多的运动伪影导致数据损坏严重。如果头动过于剧烈，可能需要重新采集数据。

通过这些步骤，可以减少 fNIRS 数据处理过程中因头动校正引入的 NA 值，从而获得更连续、可靠的信号数据。

# 5. 针对静息态fNRIS分析
在一个120秒的实验中，前30秒被试休息静止不动，之后60秒组词并说出来，之后30秒被试不停说“1，2，3”，这样的设计，我可以用前30秒的数据来做fNRIS静息态分析么？

在你的实验设计中，前30秒是被试静止不动的阶段，这段时间通常被认为是休息态 (resting-state) 的数据。然而，用这30秒的数据来做 fNIRS 静息态分析需要考虑以下几个关键点：

### 1. **静息态数据的时间长度**：
   - 静息态分析一般要求较长的时间窗口（通常是 5-10 分钟的静息态数据），因为静息态信号中的自发性低频波动 (例如 0.01-0.1 Hz) 是静息态功能连接分析的核心。这种低频波动需要足够长的时间段才能进行可靠的计算和分析。
   - 你提供的 30 秒时间段可能过短，无法捕捉到完整的低频波动，因此很难进行全面的静息态功能连接分析。

### 2. **静息态分析的目标**：
   - 静息态分析通常用于研究不同脑区之间在静息状态下的功能连接。然而，30秒的时间段较短，不足以提供足够的信号变化来估计可靠的连接性指标（如相关性或互信息）。
   - 如果你的分析目标仅仅是想查看在这30秒内的整体脑部活动水平变化（如血氧浓度变化），而不是做静息态连接分析，那么30秒的数据是可以的，但这不属于典型的静息态分析范畴。

### 3. **实验中任务间的对比**：
   - 在这种设计中，前30秒的静止阶段更适合作为后续60秒任务条件的基线（baseline），你可以将任务条件下的信号变化与前30秒的静息数据进行比较，而不是单独做静息态分析。
   - 你可以使用 GLM（广义线性模型）分析，设定前30秒为基线，后续60秒为任务态，从而得出任务相关的激活情况。

### 4. **静息态分析替代方案**：
   - 如果你的目标是研究静息态功能连接，可以考虑单独设计一个更长的静息态实验来收集足够的静息数据。一般来说，5-10分钟的静息态数据是比较标准的长度。
   - 在你的现有设计中，前30秒可以用于基础的基线校正，但静息态连接分析效果有限。

### 总结
尽管你的实验设计中前30秒是静止的，这段时间较短，难以进行典型的静息态 fNIRS 分析。你可以将其用于基线校正，但要进行静息态连接分析，建议收集更长的静息数据。

# 6。关于重采样
重采样（Resampling）: 将原始时间序列重新采样为新的固定采样率。

我有两组数据，一组数据是用每秒采样50次的近红外机器收集的；另外一组是用每秒采样10次的机器收集的，都是做的VFT(词语流程性任务)。 在进行组间对比分析之前的预处理阶段，需要对每秒采样50次的数据进行“重采样”么，意思是把它重采样到每秒10次？ 然后再进行GLM提取任务态激活信号，再对激活信号进行组间比较。

是的，在您描述的情况下，为了进行组间对比分析，建议**先对采样频率较高的组（50次/秒）的数据进行“重采样”**，以确保两组数据的采样率一致。这样可以避免因采样频率差异导致的数据处理和分析结果的偏差。以下是详细的解释和步骤建议：

### **为什么需要重采样？**

1. **统一采样频率**：
   - 不同的采样频率可能导致时间序列数据的时序不一致，使得同一时间段的信号不能直接对比。
   - 在 fNIRS 分析中，尤其是任务态分析时，信号变化的细节（如任务激活、去噪声等）会受到采样频率的影响。因此，统一采样频率可以确保在处理如滤波、降噪和建模时，数据的时间尺度保持一致。

2. **简化后续处理**：
   - 如果不对数据进行重采样，后续的滤波、广义线性模型（GLM）分析以及组间比较时，处理流程会因为采样率不同而变得复杂。
   - 通过重采样，您可以在同一采样频率下处理所有数据，简化后续的信号处理流程，如滤波和GLM分析。

### **如何进行重采样？**

您可以通过对采样频率较高的 50 Hz 数据进行降频处理（重采样到 10 Hz）。以下是一些常见的重采样方法：

1. **NIRS-KIT 中的重采样设置**：
   您可以使用重采样设置将 50 Hz 数据重采样为 10 Hz。该函数会在重采样过程中应用抗混叠滤波器，确保信号质量。
   
2. **抗混叠滤波**：
   在重采样过程中，务必使用抗混叠滤波器来去除超过目标采样率（10 Hz）的一些高频噪声，避免由于降采样而产生的混叠效应。

### **重采样后的预处理步骤**

1. **重采样**：对 50 Hz 的数据进行降频处理，重采样到 10 Hz，确保两组数据的采样率一致。
   
2. **去漂移和滤波**：
   - **带通滤波**：通常使用如 0.01 Hz 到 0.08 Hz 的带通滤波器，去除低频漂移（如仪器漂移）和高频噪声（如心跳、呼吸伪影）。
   
3. **去除伪影（如头动校正）**：
   - 可以应用头动校正算法（如 CBSI 或 TDDR）以减少头动伪影的影响。

4. **广义线性模型（GLM）**提取任务相关信号：
   - 使用 GLM 通过设计矩阵对数据建模，提取任务态的激活信号（如 beta 值），对每个被试提取任务相关的激活程度。

5. **组间比较**：
   - 最后，对提取的任务激活信号（通常为 GLM 提取的 beta 值）进行组间比较，使用统计检验（如 t 检验或方差分析 ANOVA）评估两组之间的差异。

### **总结**

为了进行有效的组间对比分析，建议先将 50 Hz 的数据进行重采样到 10 Hz，使两组数据的采样率一致。统一采样率后，可以进行常规的预处理步骤，如滤波、伪影去除和 GLM 分析，最后再进行组间比较。

- **重采样步骤**：将 50 Hz 数据通过 `resample()` 函数重采样到 10 Hz。
- **后续预处理**：完成重采样后，进行滤波、伪影去除，再进行 GLM 提取任务态信号。
- **组间比较**：对提取的激活信号进行组间统计检验，评估差异。

这样可以确保数据的一致性，并使组间比较结果更加可靠。

使用 data Viewer 比较预处理后的数据和原始时间序列，然后确定预处理方法和步骤顺
序。注意，如果在预处理过程中进行剪切数据和重采样，原始时间点和标记点可能会发
生更改。需要确保在下一个任务 fNIRS 个体水平分析（GLM 构建）中输入的设计信息
与预处理的数据是正确的。

# 7.关于预处理阶段那个自定义函数
这个函数是一个用于fNIRS(功能性近红外光谱)数据预处理的自定义函数,名为`NK_SignalSeparation_Yamada`。它的主要功能是将fNIRS信号分离成功能性成分和系统性成分。以下是对其功能的详细解释:

1. 输入参数:
   - `nirsdata`: 包含原始fNIRS数据的结构体
   - `kf`: 默认值为-0.6,用于计算去氧血红蛋白的功能性成分
   - `step`: 用于估计`ks`的步长,默认为0.05

2. 输出:
   - 更新后的`nirsdata`结构体
   - `ks`: 用于计算去氧血红蛋白的系统性成分,范围在0到1之间

3. 主要步骤:
   a. 初始化参数和数据
   b. 对每个通道进行信号分离:
      - 通过遍历不同的`ks`值(0到1,步长为`step`)来寻找最佳分离
      - 使用互信息(mutual information)来评估分离效果
      - 选择使互信息最小的`ks`值作为最佳分离参数
   c. 使用估计出的`ks`值进行实际的信号分离
   d. 将分离后的功能性成分存储回`nirsdata`结构体

4. 信号分离原理:
   - 使用线性方程组将原始信号分离为功能性成分(f)和系统性成分(s)
   - 分离基于血液动力学模态的差异
   - 使用预定义的`kf`和估计的`ks`参数进行计算

5. 数据处理:
   - 对氧合血红蛋白(oxyData)和去氧血红蛋白(dxyData)数据进行处理
   - 将起始点归一化为零
   - 分别计算功能性和系统性成分

这个函数的目的是提高fNIRS数据的质量,通过分离出功能性信号来减少系统性噪声的影响,从而提高后续分析的准确性。它基于Yamada等人2012年发表的研究方法。